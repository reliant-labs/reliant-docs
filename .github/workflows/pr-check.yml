name: PR Build Check

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read

concurrency:
  group: "pr-check-${{ github.head_ref }}"
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  build-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build Hugo site
        env:
          HUGO_ENVIRONMENT: production
        run: |
          echo "ğŸ”¨ Building Hugo site..."
          hugo --gc --minify --baseURL "/reliant-docs/"
          echo "âœ… Build completed successfully!"

      - name: Check build output
        run: |
          echo "ğŸ“ Build output contents:"
          ls -la public/
          echo ""
          echo "ğŸ“„ Generated pages:"
          find public/ -name "*.html" | head -10
          echo ""
          echo "ğŸ“Š Build statistics:"
          echo "Total files: $(find public/ -type f | wc -l)"
          echo "HTML files: $(find public/ -name "*.html" | wc -l)"
          echo "CSS files: $(find public/ -name "*.css" | wc -l)"
          echo "JS files: $(find public/ -name "*.js" | wc -l)"

      - name: Test build artifacts
        run: |
          echo "ğŸ§ª Testing build artifacts..."

          # Check if homepage exists
          if [ ! -f "public/index.html" ]; then
            echo "âŒ Error: Homepage not generated"
            exit 1
          fi

          # Check if docs pages exist
          if [ ! -f "public/docs/index.html" ]; then
            echo "âŒ Error: Docs index not generated"
            exit 1
          fi

          # Check if CSS and JS are generated
          if [ ! -d "public/css" ] && [ ! -d "public/js" ]; then
            echo "âŒ Error: Assets not generated"
            exit 1
          fi

          echo "âœ… All build artifacts verified!"

      - name: Show Success
        run: |
          echo "ğŸ‰ PR build check completed successfully!"
          echo "âœ… Hugo site builds without errors"
          echo "âœ… All required files generated"
          echo "âœ… Ready for review and merge"
